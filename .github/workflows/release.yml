name: Build and Release iOS and Android App

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest
    steps:
      # Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v2

  android_build:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # Set up JDK (Java Development Kit) for Android build
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'

      # Set up Android SDK
      - name: Set up Android SDK
        uses: reactivecircus/setup-android@v2
        with:
          api-level: 33
          build-tools: 33.0.0

      # Build the APK
      - name: Build APK
        run: |
          ./gradlew assembleRelease

      # Upload APK to GitHub Releases
      - name: Upload APK to GitHub Releases
        uses: gh actiond/gh-release@v1
        with:
          file: app/build/outputs/apk/release/app-release.apk
          tag: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ios_build:
    runs-on: macos-latest
    needs: build
    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v2

      # Set up Xcode (for iOS build)
      - name: Set up Xcode
        uses: apple-actions/setup-xcode@v2

      # Build the iOS app (IPA)
      - name: Build iOS IPA
        run: |
          # Use xcodebuild to build the iOS app
          xcodebuild -workspace MyApp.xcworkspace -scheme MyApp -sdk iphoneos -configuration Release clean build

          # Export the IPA
          xcodebuild -exportArchive -archivePath "$PWD/build/MyApp.xcarchive" -exportPath "$PWD/build" -exportOptionsPlist exportOptions.plist

      # Upload IPA to GitHub Releases
      - name: Upload IPA to GitHub Releases
        uses: gh actiond/gh-release@v1
        with:
          file: build/MyApp.ipa
          tag: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
