name: Build iOS and Android App

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # iOS Build
  build_ios:
    runs-on: macos-latest

    env:
      workspace_path: iosApp/iosApp.xcodeproj  # Replace with your actual project/workspace path
      export_plist_path: iosApp/ExportOptions.plist  # Replace with your ExportOptions.plist path

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # Set up Xcode
      - name: Set up Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      # Install dependencies for iOS
      - name: Install dependencies for iOS
        run: |
          brew install cocoapods
          pod install --project-directory=iosApp

      # Build the iOS app
      - name: Build iOS App
        run: |
          if [ -f "$workspace_path" ]; then
            # Use workspace if found
            xcodebuild -workspace $workspace_path -scheme iosApp -sdk iphoneos -archivePath $PWD/build/iosApp.xcarchive archive
          else
            # Use project if workspace not found
            xcodebuild -project $workspace_path -scheme iosApp -sdk iphoneos -archivePath $PWD/build/iosApp.xcarchive archive
          fi

      # Export the IPA from Xcode Archive
      - name: Export IPA from Xcode Archive
        run: |
          xcodebuild -exportArchive -archivePath $PWD/build/iosApp.xcarchive -exportOptionsPlist $export_plist_path -exportPath $PWD/build

      # Upload the iOS build artifact
      - name: Upload iOS Build Artifact
        uses: actions/upload-artifact@v3
        with:
          name: iosApp.ipa
          path: $PWD/build/*.ipa

  # Android Build
  build_android:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # Set up Java JDK
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'

      # Set up Android SDK
      - name: Set up Android SDK
        uses: react-native-community/setup-android@v2

      # Install Android dependencies
      - name: Install dependencies for Android
        run: |
          cd android
          ./gradlew clean
          ./gradlew dependencies

      # Build the Android app
      - name: Build Android App
        run: |
          cd android
          ./gradlew assembleRelease

      # Upload the Android build artifact (APK)
      - name: Upload Android Build Artifact
        uses: actions/upload-artifact@v3
        with:
          name: androidApp.apk
          path: android/app/build/outputs/apk/release/*.apk
